<%@ page contentType="text/html;charset=utf-8" %>
<%@ taglib prefix="c" uri="jakarta.tags.core" %>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags" %>
<%@ taglib prefix="fmt" uri="jakarta.tags.fmt" %>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="icon" href="/img/favicon.svg" type="image/png" />
    <link rel="stylesheet" href="/css/global.css" />
    <link rel="stylesheet" href="/css/pages/payment/payment.css" />
    <!-- ÌÜ†Ïä§ ÌéòÏù¥Î®ºÏ∏† Í≤∞Ï†ú SDK -->
    <script src="https://js.tosspayments.com/v1/payment"></script>
    <title>Í∞ïÏùò Í≤∞Ï†ú | Mulang</title>
</head>
<body>
<%@ include file="../common/header.jsp" %>

<main>
    <div class="payment-container">
        <h1 class="payment-title">Í∞ïÏùò Í≤∞Ï†ú</h1>
        <p class="payment-subtitle">ÌèâÏÉù ÏÜåÏû• Í∞ÄÎä•Ìïú Í∞ïÏùòÎ•º ÏßÄÍ∏à ÎßåÎÇòÎ≥¥ÏÑ∏Ïöî</p>

        <div class="payment-grid">
            <!-- ÏôºÏ™Ω: Í∞ïÏùò Ï†ïÎ≥¥ + Í≤∞Ï†ú ÏúÑÏ†Ø -->
            <div class="payment-main">
                <!-- Í∞ïÏùò Ìó§Îçî -->
                <div class="course-header">
                    <div class="course-thumbnail">
                        <c:choose>
                            <c:when test="${not empty course.thumbnail}">
                                <img src="${course.thumbnail}" alt="${course.title}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 16px;">
                            </c:when>
                            <c:otherwise>
                                ${course.language.name.substring(0, 1)}
                            </c:otherwise>
                        </c:choose>
                    </div>
                    <div class="course-info">
                        <h2 class="course-title">${course.title}</h2>
                        <p class="course-instructor">
                            Í∞ïÏÇ¨:
                            <c:choose>
                                <c:when test="${not empty course.teacher}">
                                    ${course.teacher.user.username}
                                </c:when>
                                <c:otherwise>
                                    Í¥ÄÎ¶¨Ïûê
                                </c:otherwise>
                            </c:choose>
                        </p>
                        <div class="course-meta">
                            <div class="meta-item">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect>
                                    <polyline points="17 2 12 7 7 2"></polyline>
                                </svg>
                                ${course.lectureCount}Í∞ú Í∞ïÏùò
                            </div>
                            <div class="meta-item">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                </svg>
                                <c:choose>
                                    <c:when test="${not empty course.averageRating}">
                                        <fmt:formatNumber value="${course.averageRating}" pattern="#.#"/>Ï†ê
                                    </c:when>
                                    <c:otherwise>
                                        ÌèâÍ∞Ä ÏóÜÏùå
                                    </c:otherwise>
                                </c:choose>
                            </div>
                            <c:if test="${not empty course.reviewCount and course.reviewCount > 0}">
                                <div class="meta-item">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="9" cy="7" r="4"></circle>
                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                    </svg>
                                    <fmt:formatNumber value="${course.reviewCount}" pattern="#,###"/>Î™Ö ÏàòÍ∞ï
                                </div>
                            </c:if>
                        </div>
                    </div>
                </div>

                <!-- Í≤∞Ï†ú Î∞©Î≤ï ÏÑπÏÖò -->
                <div class="payment-method-section">
                    <h3>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                             fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                            <line x1="1" y1="10" x2="23" y2="10"></line>
                        </svg>
                        Í≤∞Ï†ú Î∞©Î≤ï ÏÑ†ÌÉù
                    </h3>

                    <!-- ÌÖåÏä§Ìä∏ ÌôòÍ≤Ω ÏïåÎ¶º -->
                    <div class="test-notice">
                        ‚ö†Ô∏è ÌÖåÏä§Ìä∏ ÌôòÍ≤Ω - Ïã§Ï†úÎ°ú Í≤∞Ï†úÎêòÏßÄ ÏïäÏäµÎãàÎã§.
                    </div>

                    <!-- Ïª§Ïä§ÌÖÄ Í≤∞Ï†ú Î∞©Î≤ï ÏÑ†ÌÉù UI -->
                    <div class="payment-methods-grid">
                        <!-- ÏùºÎ∞òÍ≤∞Ï†ú -->
                        <div class="payment-method-item" data-method="NORMAL" data-type="CARD">
                            <div class="method-content">
                                <div class="method-icon">üí≥</div>
                                <div class="method-name">ÏùºÎ∞òÍ≤∞Ï†ú</div>
                            </div>
                        </div>

                        <!-- Ïã†Ïö©¬∑Ï≤¥ÌÅ¨Ïπ¥Îìú -->
                        <div class="payment-method-item" data-method="CARD" data-type="CARD">
                            <div class="method-content">
                                <div class="method-icon">üí≥</div>
                                <div class="method-name">Ïã†Ïö©¬∑Ï≤¥ÌÅ¨Ïπ¥Îìú</div>
                            </div>
                        </div>

                        <!-- ÌÜ†Ïä§ÌéòÏù¥ (Ï∂îÏ≤ú Î±ÉÏßÄ) -->
                        <div class="payment-method-item recommended" data-method="TOSSPAY" data-type="TOSSPAY">
                            <div class="recommended-badge">Ï†ÅÎ¶Ω ÌòúÌÉù</div>
                            <div class="method-content">
                                <img src="/img/payment/tosspay-logo.png" alt="ÌÜ†Ïä§ÌéòÏù¥" class="method-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <div class="method-icon" style="display:none;">üéØ</div>
                                <div class="method-name">ÌÜ†Ïä§ÌéòÏù¥</div>
                            </div>
                        </div>

                        <!-- PAYCO -->
                        <div class="payment-method-item" data-method="PAYCO" data-type="PAYCO">
                            <div class="method-content">
                                <img src="/img/payment/payco-logo.png" alt="PAYCO" class="method-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <div class="method-icon" style="display:none;">üí∞</div>
                                <div class="method-name">PAYCO</div>
                            </div>
                        </div>

                        <!-- Ïπ¥Ïπ¥Ïò§ÌéòÏù¥ -->
                        <div class="payment-method-item" data-method="KAKAOPAY" data-type="KAKAOPAY">
                            <div class="method-content">
                                <div class="method-icon">üíõ</div>
                                <div class="method-name">Ïπ¥Ïπ¥Ïò§ÌéòÏù¥</div>
                            </div>
                        </div>

                        <!-- ÎÑ§Ïù¥Î≤ÑÌéòÏù¥ -->
                        <div class="payment-method-item" data-method="NAVERPAY" data-type="NAVERPAY">
                            <div class="method-content">
                                <div class="method-icon">üíö</div>
                                <div class="method-name">ÎÑ§Ïù¥Î≤ÑÌéòÏù¥</div>
                            </div>
                        </div>

                        <!-- Ìú¥ÎåÄÌè∞ -->
                        <div class="payment-method-item" data-method="MOBILE" data-type="MOBILE_PHONE">
                            <div class="method-content">
                                <div class="method-icon">üì±</div>
                                <div class="method-name">Ìú¥ÎåÄÌè∞</div>
                            </div>
                        </div>
                    </div>

                    <!-- Ïã†Ïö©Ïπ¥Îìú Î¨¥Ïù¥Ïûê Ìï†Î∂Ä ÏïàÎÇ¥ -->
                    <div class="installment-info">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                             fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        Ïã†Ïö©Ïπ¥Îìú ÏµúÎåÄ 3Í∞úÏõî Î¨¥Ïù¥Ïûê Ìï†Î∂Ä
                    </div>

                    <!-- ÏïΩÍ¥Ä ÎèôÏùò -->
                    <div class="payment-agreements">
                        <div class="agreement-item">
                            <input type="checkbox" id="agree-all" class="agreement-checkbox">
                            <label for="agree-all" class="agreement-label">
                                [ÌïÑÏàò] Í≤∞Ï†ú ÏÑúÎπÑÏä§ Ïù¥Ïö© ÏïΩÍ¥Ä, Í∞úÏù∏Ï†ïÎ≥¥ Ï≤òÎ¶¨ ÎèôÏùò
                            </label>
                        </div>
                        <div class="agreement-details">
                            Ïã†Ïö©Ïπ¥Îìú Î¨¥Ïù¥Ïûê Ìï†Î∂Ä ÏïàÎÇ¥ &gt;
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ïò§Î•∏Ï™Ω: Í≤∞Ï†ú Ï†ïÎ≥¥ ÏÇ¨Ïù¥ÎìúÎ∞î -->
            <div class="payment-sidebar">
                <!-- Í≤∞Ï†ú Ï†ïÎ≥¥ -->
                <div class="order-summary-card">
                    <h3>Í≤∞Ï†ú Ï†ïÎ≥¥</h3>

                    <div class="price-breakdown">
                        <div class="price-row">
                            <span class="price-label">Í∞ïÏ¢å Í∏àÏï°</span>
                            <span class="price-value">
                                <fmt:formatNumber value="${course.price}" pattern="#,###"/>Ïõê
                            </span>
                        </div>

                        <div class="price-row discount-row" id="discount-row" style="display: none;">
                            <span class="price-label">Ïø†Ìè∞ Ìï†Ïù∏</span>
                            <span class="price-value">-5,000Ïõê</span>
                        </div>
                    </div>

                    <div class="total-row">
                        <span class="total-label">ÏµúÏ¢Ö Í≤∞Ï†ú Í∏àÏï°</span>
                        <span class="total-amount" id="total-amount">
                            <fmt:formatNumber value="${course.price}" pattern="#,###"/>Ïõê
                        </span>
                    </div>
                </div>

                <!-- Ïø†Ìè∞ Ï†ÅÏö© (ÏÑ†ÌÉùÏÇ¨Ìï≠) -->
                <div class="coupon-box" onclick="document.getElementById('coupon-box-input').click()" style="display: none;">
                    <input type="checkbox" id="coupon-box-input">
                    <label for="coupon-box-input">
                        <span class="coupon-badge">5,000Ïõê</span>
                        Ïã†Í∑ú ÌöåÏõê Ïø†Ìè∞ Ï†ÅÏö©ÌïòÍ∏∞
                    </label>
                </div>

                <!-- Î≥¥Ïïà Ï†ïÎ≥¥ -->
                <div class="security-info">
                    <p>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                             fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                        ÏïàÏ†ÑÌïú Í≤∞Ï†úÍ∞Ä Î≥¥Ïû•Îê©ÎãàÎã§
                    </p>
                </div>

                <!-- Í≤∞Ï†úÌïòÍ∏∞ Î≤ÑÌäº -->
                <button class="payment-button" id="payment-button">
                    Í≤∞Ï†úÌïòÍ∏∞
                </button>
            </div>
        </div>
    </div>
</main>

<%@ include file="../common/footer.jsp" %>

<!-- Spring Security Ïù∏Ï¶ù Ï†ïÎ≥¥Î•º JavaScript Î≥ÄÏàòÎ°ú Ï†ÑÎã¨ -->
<sec:authorize access="isAuthenticated()">
    <sec:authentication property="principal" var="userPrincipal" />
    <c:set var="currentUser" value="${userPrincipal.user}" />
    <c:set var="currentUserId" value="${currentUser.id}" />
    <c:set var="currentUserName" value="${currentUser.username}" />
    <c:set var="currentUserEmail" value="${currentUser.email}" />
</sec:authorize>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const button = document.getElementById("payment-button");
        const coupon = document.getElementById("coupon-box-input");
        const discountRow = document.getElementById("discount-row");
        const agreeCheckbox = document.getElementById("agree-all");

        // Í∞ïÏ¢å Ï†ïÎ≥¥
        const courseId = ${course.id};
        const courseTitle = "${course.title}";
        const coursePrice = ${course.price};
        let totalAmount = coursePrice;

        // Spring SecurityÏóêÏÑú Ï†ÑÎã¨Î∞õÏùÄ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥
        <sec:authorize access="isAuthenticated()">
        const userId = ${currentUserId};
        const userName = "${currentUserName}";
        const userEmail = "${currentUserEmail}";
        </sec:authorize>

        <sec:authorize access="!isAuthenticated()">
        alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌïú ÏÑúÎπÑÏä§ÏûÖÎãàÎã§.');
        window.location.href = '/login?redirect=/payments/${course.id}';
        </sec:authorize>

        // ------ 1. ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏† ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî ------
        const clientKey = "${clientKey}";
        const tossPayments = TossPayments(clientKey);

        // ------ 2. Í≤∞Ï†ú Î∞©Î≤ï ÏÑ†ÌÉù Ï≤òÎ¶¨ ------
        let selectedMethod = null;
        let selectedType = 'CARD'; // Í∏∞Î≥∏Í∞í
        const paymentMethodItems = document.querySelectorAll('.payment-method-item');

        paymentMethodItems.forEach(item => {
            item.addEventListener('click', () => {
                // Î™®Îì† ÏïÑÏù¥ÌÖúÏùò ÏÑ†ÌÉù ÏÉÅÌÉú Ï†úÍ±∞
                paymentMethodItems.forEach(el => el.classList.remove('selected'));
                // ÌÅ¥Î¶≠Îêú ÏïÑÏù¥ÌÖú ÏÑ†ÌÉù
                item.classList.add('selected');
                selectedMethod = item.dataset.method;
                selectedType = item.dataset.type;
                console.log('ÏÑ†ÌÉùÎêú Í≤∞Ï†ú Î∞©Î≤ï:', selectedMethod, selectedType);
            });
        });

        // ------ 3. Ïø†Ìè∞ Ï†ÅÏö© (ÏÑ†ÌÉùÏÇ¨Ìï≠) ------
        if (coupon) {
            coupon.addEventListener("change", () => {
                const newAmount = coupon.checked ? coursePrice - 5000 : coursePrice;
                totalAmount = newAmount;

                // UI ÏóÖÎç∞Ïù¥Ìä∏
                document.getElementById("total-amount").textContent =
                    newAmount.toLocaleString("ko-KR") + "Ïõê";

                // Ìï†Ïù∏ Ìñâ ÌëúÏãú/Ïà®ÍπÄ
                discountRow.style.display = coupon.checked ? "flex" : "none";
            });
        }

        // ------ 4. Í≤∞Ï†ú ÏöîÏ≤≠ ------
        button.addEventListener("click", async () => {
            // Í≤∞Ï†ú Î∞©Î≤ï ÏÑ†ÌÉù ÌôïÏù∏
            if (!selectedMethod) {
                alert('Í≤∞Ï†ú Î∞©Î≤ïÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            // ÏïΩÍ¥Ä ÎèôÏùò ÌôïÏù∏
            if (!agreeCheckbox.checked) {
                alert('Í≤∞Ï†ú ÏÑúÎπÑÏä§ Ïù¥Ïö© ÏïΩÍ¥ÄÏóê ÎèôÏùòÌï¥Ï£ºÏÑ∏Ïöî.');
                agreeCheckbox.focus();
                return;
            }

            try {
                // Ï£ºÎ¨∏ ID ÏÉùÏÑ± (Í≤∞Ï†ú Ï§ÄÎπÑ API Ìò∏Ï∂ú)
                const prepareResponse = await fetch('/payments/prepare?userId=' + userId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        courseId: courseId,
                        amount: totalAmount,
                        orderName: courseTitle
                    })
                });

                if (!prepareResponse.ok) {
                    throw new Error('Í≤∞Ï†ú Ï§ÄÎπÑÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }

                const prepareData = await prepareResponse.json();
                const orderId = prepareData.orderId;

                // ÌÜ†Ïä§ÌéòÏù¥Î®ºÏ∏† Í≤∞Ï†ú ÏöîÏ≤≠
                await tossPayments.requestPayment(selectedType, {
                    amount: totalAmount,
                    orderId: orderId,
                    orderName: courseTitle,
                    customerName: userName,
                    customerEmail: userEmail,
                    successUrl: window.location.origin + "/payments/success",
                    failUrl: window.location.origin + "/payments/fail",
                });

            } catch (error) {
                console.error('Í≤∞Ï†ú Ïò§Î•ò:', error);
                if (error.code === 'USER_CANCEL') {
                    alert("Í≤∞Ï†úÎ•º Ï∑®ÏÜåÌïòÏÖ®ÏäµÎãàÎã§.");
                } else {
                    alert("Í≤∞Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + (error.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                }
            }
        });
    });
</script>
</body>
</html>
