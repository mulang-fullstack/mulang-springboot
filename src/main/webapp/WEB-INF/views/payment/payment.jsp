<%@ page contentType="text/html;charset=utf-8" %>
<%@ taglib prefix="c" uri="jakarta.tags.core" %>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags" %>
<%@ taglib prefix="fmt" uri="jakarta.tags.fmt" %>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="icon" href="/img/favicon.svg" type="image/png" />
    <link rel="stylesheet" href="/css/global.css" />
    <link rel="stylesheet" href="/css/pages/payment/payment.css" />
    <!-- ÌÜ†Ïä§ ÌéòÏù¥Î®ºÏ∏† Í≤∞Ï†ú SDK -->
    <script src="https://js.tosspayments.com/v1/payment"></script>
    <title>Í∞ïÏùò Í≤∞Ï†ú | Mulang</title>
</head>
<body>
<%@ include file="../common/header.jsp" %>

<main>
    <div class="payment-container">
        <h1 class="payment-title">Í∞ïÏùò Í≤∞Ï†ú</h1>
        <p class="payment-subtitle">ÌèâÏÉù ÏÜåÏû• Í∞ÄÎä•Ìïú Í∞ïÏùòÎ•º ÏßÄÍ∏à ÎßåÎÇòÎ≥¥ÏÑ∏Ïöî</p>

        <div class="payment-grid">
            <!-- ÏôºÏ™Ω: Í∞ïÏùò Ï†ïÎ≥¥ + Í≤∞Ï†ú ÏúÑÏ†Ø -->
            <div class="payment-main">
                <!-- Í∞ïÏùò Ìó§Îçî -->
                <div class="course-header">
                    <div class="course-thumbnail">
                        <c:choose>
                            <c:when test="${not empty payment.thumbnailUrl}">
                                <img src="${payment.thumbnailUrl}" alt="${payment.courseTitle}"
                                     style="width: 100%; height: 100%; object-fit: cover; border-radius: 16px;">
                            </c:when>
                            <c:otherwise>
                                <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #f5f5f5; border-radius: 16px;">
                                    üìö
                                </div>
                            </c:otherwise>
                        </c:choose>
                    </div>
                    <div class="course-info">
                        <h2 class="course-title">${payment.courseTitle}</h2>
                        <p class="course-instructor">
                            Í∞ïÏÇ¨:
                            <c:choose>
                                <c:when test="${not empty payment.teacherNickname}">
                                    ${payment.teacherNickname}
                                </c:when>
                                <c:otherwise>
                                    Ïù¥Î¶ÑÏóÜÏùå
                                </c:otherwise>
                            </c:choose>
                        </p>
                        <div class="course-meta">
                            <div class="meta-item">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect>
                                    <polyline points="17 2 12 7 7 2"></polyline>
                                </svg>
                                ${payment.lectureCount}Í∞ú Í∞ïÏùò
                            </div>
                            <div class="meta-item">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                     fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                </svg>
                                <c:choose>
                                    <c:when test="${not empty payment.averageRating and payment.averageRating > 0}">
                                        <fmt:formatNumber value="${payment.averageRating}" pattern="#.#"/>Ï†ê
                                    </c:when>
                                    <c:otherwise>
                                        ÌèâÍ∞Ä ÏóÜÏùå
                                    </c:otherwise>
                                </c:choose>
                            </div>
                            <c:if test="${not empty payment.reviewCount and payment.reviewCount > 0}">
                                <div class="meta-item">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="9" cy="7" r="4"></circle>
                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                    </svg>
                                    <fmt:formatNumber value="${payment.reviewCount}" pattern="#,###"/>Î™Ö ÏàòÍ∞ï
                                </div>
                            </c:if>
                        </div>
                    </div>
                </div>

                <!-- Í≤∞Ï†ú Î∞©Î≤ï ÏÑπÏÖò -->
                <div class="payment-method-section">
                    <h3>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                             fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                            <line x1="1" y1="10" x2="23" y2="10"></line>
                        </svg>
                        Í≤∞Ï†ú Î∞©Î≤ï ÏÑ†ÌÉù
                    </h3>

                    <!-- ÌÖåÏä§Ìä∏ ÌôòÍ≤Ω ÏïåÎ¶º -->
                    <div class="test-notice">
                        ‚ö†Ô∏è ÌÖåÏä§Ìä∏ ÌôòÍ≤Ω - Ïã§Ï†úÎ°ú Í≤∞Ï†úÎêòÏßÄ ÏïäÏäµÎãàÎã§.
                    </div>

                    <!-- Ïª§Ïä§ÌÖÄ Í≤∞Ï†ú Î∞©Î≤ï ÏÑ†ÌÉù UI -->
                    <div class="payment-methods-grid">
                        <!-- ÏùºÎ∞òÍ≤∞Ï†ú -->
                        <div class="payment-method-item" data-method="NORMAL" data-type="CARD">
                            <div class="method-content">
                                <div class="method-icon">üí≥</div>
                                <div class="method-name">ÏùºÎ∞òÍ≤∞Ï†ú</div>
                            </div>
                        </div>

                        <!-- Ïã†Ïö©¬∑Ï≤¥ÌÅ¨Ïπ¥Îìú -->
                        <div class="payment-method-item" data-method="CARD" data-type="CARD">
                            <div class="method-content">
                                <div class="method-icon">üí≥</div>
                                <div class="method-name">Ïã†Ïö©¬∑Ï≤¥ÌÅ¨Ïπ¥Îìú</div>
                            </div>
                        </div>

                        <!-- ÌÜ†Ïä§ÌéòÏù¥ (Ï∂îÏ≤ú Î±ÉÏßÄ) -->
                        <div class="payment-method-item recommended" data-method="TOSSPAY" data-type="TOSSPAY">
                            <div class="recommended-badge">Ï†ÅÎ¶Ω ÌòúÌÉù</div>
                            <div class="method-content">
                                <img src="/img/payment/tosspay-logo.png" alt="ÌÜ†Ïä§ÌéòÏù¥" class="method-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <div class="method-icon" style="display:none;">üéØ</div>
                                <div class="method-name">ÌÜ†Ïä§ÌéòÏù¥</div>
                            </div>
                        </div>

                        <!-- PAYCO -->
                        <div class="payment-method-item" data-method="PAYCO" data-type="PAYCO">
                            <div class="method-content">
                                <img src="/img/payment/payco-logo.png" alt="PAYCO" class="method-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <div class="method-icon" style="display:none;">üí∞</div>
                                <div class="method-name">PAYCO</div>
                            </div>
                        </div>

                        <!-- Ïπ¥Ïπ¥Ïò§ÌéòÏù¥ -->
                        <div class="payment-method-item" data-method="KAKAOPAY" data-type="KAKAOPAY">
                            <div class="method-content">
                                <div class="method-icon">üíõ</div>
                                <div class="method-name">Ïπ¥Ïπ¥Ïò§ÌéòÏù¥</div>
                            </div>
                        </div>

                        <!-- ÎÑ§Ïù¥Î≤ÑÌéòÏù¥ -->
                        <div class="payment-method-item" data-method="NAVERPAY" data-type="NAVERPAY">
                            <div class="method-content">
                                <div class="method-icon">üíö</div>
                                <div class="method-name">ÎÑ§Ïù¥Î≤ÑÌéòÏù¥</div>
                            </div>
                        </div>

                        <!-- Ìú¥ÎåÄÌè∞ -->
                        <div class="payment-method-item" data-method="MOBILE" data-type="MOBILE_PHONE">
                            <div class="method-content">
                                <div class="method-icon">üì±</div>
                                <div class="method-name">Ìú¥ÎåÄÌè∞</div>
                            </div>
                        </div>
                    </div>

                    <!-- Ïã†Ïö©Ïπ¥Îìú Î¨¥Ïù¥Ïûê Ìï†Î∂Ä ÏïàÎÇ¥ -->
                    <div class="installment-info">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                             fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        <p>Í≤∞Ï†ú Í∏àÏï°Ïóê Îî∞Îùº Î¨¥Ïù¥Ïûê Ìï†Î∂ÄÍ∞Ä Ï†ÅÏö©Îê©ÎãàÎã§</p>
                    </div>
                </div>

                <!-- ÏïΩÍ¥Ä ÎèôÏùò -->
                <div class="terms-section">
                    <label class="terms-item">
                        <input type="checkbox" id="agree-all" />
                        <span>Í≤∞Ï†ú ÏÑúÎπÑÏä§ Ïù¥Ïö© ÏïΩÍ¥ÄÏóê ÎèôÏùòÌï©ÎãàÎã§ (ÌïÑÏàò)</span>
                    </label>
                </div>
            </div>

            <!-- Ïò§Î•∏Ï™Ω: Í≤∞Ï†ú Í∏àÏï° ÏöîÏïΩ -->
            <div class="payment-summary">
                <h3>Í≤∞Ï†ú Í∏àÏï°</h3>

                <div class="price-breakdown">
                    <div class="price-row">
                        <span class="price-label">Í∞ïÏùò Í∞ÄÍ≤©</span>
                        <span class="price-value">
                            <fmt:formatNumber value="${payment.amount}" pattern="#,###"/>Ïõê
                        </span>
                    </div>

                    <div class="price-row discount-row" id="discount-row" style="display: none;">
                        <span class="price-label">Ïø†Ìè∞ Ìï†Ïù∏</span>
                        <span class="price-value">-5,000Ïõê</span>
                    </div>
                </div>

                <div class="total-row">
                    <span class="total-label">ÏµúÏ¢Ö Í≤∞Ï†ú Í∏àÏï°</span>
                    <span class="total-amount" id="total-amount">
                        <fmt:formatNumber value="${payment.amount}" pattern="#,###"/>Ïõê
                    </span>
                </div>
            </div>

            <!-- Î≥¥Ïïà Ï†ïÎ≥¥ -->
            <div class="security-info">
                <p>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    ÏïàÏ†ÑÌïú Í≤∞Ï†úÍ∞Ä Î≥¥Ïû•Îê©ÎãàÎã§
                </p>
            </div>

            <!-- Í≤∞Ï†úÌïòÍ∏∞ Î≤ÑÌäº -->
            <button class="payment-button" id="payment-button">
                Í≤∞Ï†úÌïòÍ∏∞
            </button>
        </div>
    </div>
</main>

<%@ include file="../common/footer.jsp" %>

<!-- Spring Security Ïù∏Ï¶ù Ï†ïÎ≥¥Î•º JavaScript Î≥ÄÏàòÎ°ú Ï†ÑÎã¨ -->
<sec:authorize access="isAuthenticated()">
    <sec:authentication property="principal" var="userPrincipal" />
    <c:set var="currentUser" value="${userPrincipal.user}" />
    <c:set var="currentUserId" value="${currentUser.id}" />
    <c:set var="currentUserName" value="${currentUser.username}" />
    <c:set var="currentUserEmail" value="${currentUser.email}" />
</sec:authorize>

<!-- Îç∞Ïù¥ÌÑ∞ Ï†ÑÎã¨Ïö© -->
<script>
    window.PAYMENT_DATA = {
        // Í≤∞Ï†ú Ï†ïÎ≥¥ (PaymentPageResponse)
        orderId: "${payment.orderId}",
        amount: ${payment.amount},
        courseId: ${payment.courseId},
        courseTitle: "${payment.courseTitle}",

        // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ (Spring Security)
        <sec:authorize access="isAuthenticated()">
        userId: ${currentUserId},
        userName: "${currentUserName}",
        userEmail: "${currentUserEmail}",
        isAuthenticated: true
        </sec:authorize>

        <sec:authorize access="!isAuthenticated()">
        isAuthenticated: false
        </sec:authorize>
    };

    window.TOSS_CLIENT_KEY = "${clientKey}";
</script>

<!-- JavaScript Î∂ÑÎ¶¨ -->
<script src="/js/pages/payment/payment.js"></script>
<script src="/js/common/utils.js"></script>
</body>
</html>
